# =============================================================================
# Kubernetes Deployment - Frontend (Next.js)
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
  namespace: default
  labels:
    app: todo-application
    component: frontend
    tier: presentation
spec:
  # Number of pod replicas
  replicas: 2

  # Rolling update strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%        # Allow 25% more pods during update
      maxUnavailable: 25%  # Allow 25% unavailable during update

  # Pod selector
  selector:
    matchLabels:
      app: todo-application
      component: frontend

  # Pod template
  template:
    metadata:
      labels:
        app: todo-application
        component: frontend
        tier: presentation
    spec:
      # Security: Run containers as non-root
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001

      containers:
        - name: frontend
          image: todo-frontend:latest
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 3000
              protocol: TCP

          # Environment variables from ConfigMap
          env:
            - name: NODE_ENV
              valueFrom:
                configMapKeyRef:
                  name: todo-config
                  key: NODE_ENV

            - name: NEXT_PUBLIC_API_URL
              valueFrom:
                configMapKeyRef:
                  name: todo-config
                  key: NEXT_PUBLIC_API_URL

          # Resource limits and requests
          resources:
            requests:
              cpu: "100m"      # 0.1 CPU core
              memory: "128Mi"  # 128 MiB RAM
            limits:
              cpu: "500m"      # 0.5 CPU core max
              memory: "512Mi"  # 512 MiB RAM max

          # Liveness probe - restart container if unhealthy
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10  # Wait 10s before first check
            periodSeconds: 10        # Check every 10s
            timeoutSeconds: 5        # Timeout after 5s
            failureThreshold: 3      # Restart after 3 failures

          # Readiness probe - remove from service if not ready
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5   # Wait 5s before first check
            periodSeconds: 5         # Check every 5s
            timeoutSeconds: 3        # Timeout after 3s
            failureThreshold: 3      # Mark unready after 3 failures

          # Startup probe - allow sufficient initialization time
          startupProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 0   # Start checking immediately
            periodSeconds: 5         # Check every 5s
            timeoutSeconds: 3        # Timeout after 3s
            failureThreshold: 30     # Allow 30 failures (150s total)

          # Security context for container
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1001
            capabilities:
              drop:
                - ALL

      # Restart policy
      restartPolicy: Always

---
# =============================================================================
# Usage Instructions
# =============================================================================
#
# Apply deployment:
#   kubectl apply -f frontend-deployment.yaml
#
# Check status:
#   kubectl get deployment frontend-deployment
#   kubectl get pods -l component=frontend
#
# View logs:
#   kubectl logs -l component=frontend --tail=50 -f
#
# Scale replicas:
#   kubectl scale deployment frontend-deployment --replicas=3
#
# Update image:
#   kubectl set image deployment/frontend-deployment frontend=todo-frontend:v2
#
# Rollback:
#   kubectl rollout undo deployment/frontend-deployment
#
# =============================================================================
