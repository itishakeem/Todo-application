# =============================================================================
# Kubernetes Deployment - Backend (FastAPI)
# =============================================================================

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
  namespace: default
  labels:
    app: todo-application
    component: backend
    tier: application
spec:
  # Number of pod replicas
  replicas: 2

  # Rolling update strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%        # Allow 25% more pods during update
      maxUnavailable: 25%  # Allow 25% unavailable during update

  # Pod selector
  selector:
    matchLabels:
      app: todo-application
      component: backend

  # Pod template
  template:
    metadata:
      labels:
        app: todo-application
        component: backend
        tier: application
    spec:
      # Security: Run containers as non-root
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001

      containers:
        - name: backend
          image: todo-backend:latest
          imagePullPolicy: IfNotPresent

          ports:
            - name: http
              containerPort: 8000
              protocol: TCP

          # Environment variables from ConfigMap and Secrets
          env:
            # From ConfigMap
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: todo-config
                  key: ENVIRONMENT

            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: todo-config
                  key: LOG_LEVEL

            - name: CORS_ORIGINS
              valueFrom:
                configMapKeyRef:
                  name: todo-config
                  key: CORS_ORIGINS

            - name: BETTER_AUTH_URL
              valueFrom:
                configMapKeyRef:
                  name: todo-config
                  key: BETTER_AUTH_URL

            # From Secrets (secure injection via secretKeyRef)
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: todo-secrets
                  key: DATABASE_URL

            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: todo-secrets
                  key: OPENAI_API_KEY

            - name: GEMINI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: todo-secrets
                  key: GEMINI_API_KEY

            - name: BETTER_AUTH_SECRET
              valueFrom:
                secretKeyRef:
                  name: todo-secrets
                  key: BETTER_AUTH_SECRET

          # Resource limits and requests
          resources:
            requests:
              cpu: "100m"      # 0.1 CPU core
              memory: "256Mi"  # 256 MiB RAM
            limits:
              cpu: "500m"      # 0.5 CPU core max
              memory: "512Mi"  # 512 MiB RAM max

          # Liveness probe - restart container if unhealthy
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 15  # Wait 15s before first check
            periodSeconds: 10         # Check every 10s
            timeoutSeconds: 5         # Timeout after 5s
            failureThreshold: 3       # Restart after 3 failures

          # Readiness probe - remove from service if not ready
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10  # Wait 10s before first check
            periodSeconds: 5         # Check every 5s
            timeoutSeconds: 3        # Timeout after 3s
            failureThreshold: 3      # Mark unready after 3 failures

          # Startup probe - allow sufficient initialization time
          startupProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 0   # Start checking immediately
            periodSeconds: 5         # Check every 5s
            timeoutSeconds: 3        # Timeout after 3s
            failureThreshold: 30     # Allow 30 failures (150s total)

          # Security context for container
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1001
            capabilities:
              drop:
                - ALL

      # Restart policy
      restartPolicy: Always

---
# =============================================================================
# Usage Instructions
# =============================================================================
#
# Apply deployment:
#   kubectl apply -f backend-deployment.yaml
#
# Check status:
#   kubectl get deployment backend-deployment
#   kubectl get pods -l component=backend
#
# View logs:
#   kubectl logs -l component=backend --tail=50 -f
#
# Scale replicas:
#   kubectl scale deployment backend-deployment --replicas=3
#
# Update image:
#   kubectl set image deployment/backend-deployment backend=todo-backend:v2
#
# Rollback:
#   kubectl rollout undo deployment/backend-deployment
#
# Check environment variables:
#   kubectl exec -it <backend-pod> -- env | grep -E "DATABASE|OPENAI|AUTH"
#
# =============================================================================
